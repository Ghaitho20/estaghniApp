pipeline {
    agent any

    environment {
        IMAGE_NAME = "estaghni"
        IMAGE_TAG  = "${BUILD_NUMBER}"
        SCANNER_HOME = tool 'sonar-scanner'
    }

    stages {

        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout Code') {
            steps {
                git branch: 'master',
                    url: 'https://github.com/Ghaitho20/estaghniApp.git'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('sonar-server') {
                    sh """
                    $SCANNER_HOME/bin/sonar-scanner \
                    -Dsonar.projectName=estaghni \
                    -Dsonar.projectKey=estaghni
                    """
                }
            }
        }

        stage('Trivy Source Scan') {
            steps {
                sh """
                trivy fs --scanners vuln,secret \
                --format table \
                -o trivy-source-report.html .
                """
            }
        }

        stage('Build Docker Image') {
            steps {
                sh """
                docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
                """
            }
        }

        stage('Trivy Image Scan') {
            steps {
                sh """
                trivy image --timeout 20m \
                --format table \
                -o trivy-image-report.html \
                ${IMAGE_NAME}:${IMAGE_TAG}
                """
            }
        }

        stage('Publish Trivy Reports') {
            steps {
                publishHTML([
                    reportDir: '.',
                    reportFiles: 'trivy-source-report.html,trivy-image-report.html',
                    reportName: 'Trivy Security Reports',
                    keepAll: true,
                    alwaysLinkToLastBuild: true,
                    allowMissing: true
                ])
            }
        }

        stage('Deploy to Minikube (Helm)') {
            steps {
                sh """
                eval \$(minikube docker-env)
                helm upgrade --install k8s-manifest ./k8s-mainfest \
                --set image.tag=${IMAGE_TAG}
                """
            }
        }
    }
}